<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบลงทะเบียน LINE</title>
  
  <!-- LIFF SDK เวอร์ชันล่าสุด -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.21.4/sdk.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            accent: '#8b5cf6',
            dark: '#1e293b'
          }
        }
      }
    }
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      min-height: 100vh;
    }
    
    .file-card {
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out;
    }
    
    .file-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .success-check {
      animation: checkmark 0.5s ease-out;
    }
    
    @keyframes checkmark {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .profile-pic {
      border: 3px solid #3b82f6;
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
    }
    
    input:read-only {
      background-color: #f9fafb;
      cursor: not-allowed;
    }
    
    .form-container {
      max-height: 1000px;
      transition: max-height 0.5s ease-in-out;
    }
    
    .form-container.hidden {
      max-height: 0;
      overflow: hidden;
    }
    
    .error-container {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      animation: fadeIn 0.3s ease;
    }

    .drag-over {
      border-color: #3b82f6 !important;
      background-color: #eff6ff !important;
    }
    
    .file-preview-img {
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
    }
    
    .file-icon {
      font-size: 2.5rem;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Header with LINE Profile -->
    <div class="text-center mb-8">
      <div id="profileSection" class="flex flex-col items-center">
        <div class="relative mb-4">
          <img id="profilePicture" class="w-24 h-24 rounded-full profile-pic object-cover bg-gray-200" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile Picture">
          <div class="absolute bottom-0 right-0 w-6 h-6 bg-primary rounded-full flex items-center justify-center">
            <i class="fas fa-check text-white text-xs"></i>
          </div>
        </div>
        <h1 id="lineName" class="text-2xl font-bold text-gray-800 mb-1">กรุณาล็อกอินผ่าน LINE</h1>
        <p id="lineEmail" class="text-gray-600 text-sm">-</p>
      </div>
      <div class="mt-4">
        <h2 class="text-3xl font-bold text-gray-800">ระบบลงทะเบียน</h2>
        <p class="text-gray-600 mt-2">กรุณาตรวจสอบและกรอกข้อมูลให้ครบถ้วน</p>
      </div>
    </div>
    
    <!-- Error Message Container -->
    <div id="errorContainer" class="error-container hidden">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-exclamation-circle text-red-500 text-xl mt-1"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800" id="errorTitle">เกิดข้อผิดพลาด</h3>
          <div class="mt-2 text-sm text-red-700">
            <p id="errorMessage">ไม่สามารถเชื่อมต่อกับ LINE ได้ กรุณาลองใหม่อีกครั้ง</p>
            <p id="errorDetails" class="text-xs mt-1 hidden"></p>
          </div>
          <div class="mt-4">
            <button id="retryButton" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
              <i class="fas fa-redo mr-1"></i> ลองอีกครั้ง
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Login Button -->
    <div id="loginContainer" class="text-center my-8">
      <button id="loginButton" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
        <i class="fab fa-line mr-2"></i> ล็อกอินด้วย LINE
      </button>
      <p class="text-gray-600 mt-3 text-sm">กรุณาล็อกอินเพื่อเริ่มใช้งานระบบ</p>
    </div>
    
    <!-- Registration Form -->
    <div id="formContainer" class="form-container bg-white rounded-2xl shadow-xl overflow-hidden transition-all duration-500 hidden">
      <div class="p-6 sm:p-8">
        <form id="registrationForm">
          <!-- User ID (Hidden) -->
          <input type="hidden" id="userId" name="userId">
          
          <!-- Name -->
          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name">
              <i class="fas fa-user text-primary mr-1"></i> ชื่อ-นามสกุล <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input class="w-full py-3 px-4 pl-11 text-gray-700 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                     id="name" name="name" type="text" placeholder="กรุณากรอกชื่อเต็ม" required>
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-user text-gray-400"></i>
              </div>
            </div>
          </div>
          
          <!-- Email -->
          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
              <i class="fas fa-envelope text-primary mr-1"></i> อีเมล <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input class="w-full py-3 px-4 pl-11 text-gray-700 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                     id="email" name="email" type="email" placeholder="example@domain.com" required>
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-envelope text-gray-400"></i>
              </div>
            </div>
          </div>
          
          <!-- Phone -->
          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="phone">
              <i class="fas fa-phone text-primary mr-1"></i> เบอร์โทรศัพท์ <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input class="w-full py-3 px-4 pl-11 text-gray-700 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                     id="phone" name="phone" type="tel" placeholder="0812345678" required pattern="[0-9]{10}">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-phone text-gray-400"></i>
              </div>
            </div>
          </div>
          
          <!-- File Upload -->
          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">
              <i class="fas fa-file-upload text-primary mr-1"></i> อัปโหลดไฟล์ (สูงสุด 3 ไฟล์, ไฟล์ละไม่เกิน 2MB)
            </label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer" id="dropZone">
              <div class="space-y-1 text-center">
                <div class="flex text-sm text-gray-600 justify-center">
                  <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-blue-500">
                    <span>คลิกเพื่อเลือกไฟล์</span>
                    <input id="fileInput" type="file" class="sr-only" multiple accept="image/*, .pdf, .doc, .docx, .xls, .xlsx" max="3">
                  </label>
                </div>
                <p class="text-xs text-gray-500">PNG, JPG, PDF, DOC, XLS (ขนาดไม่เกิน 2MB)</p>
                <p class="text-xs text-gray-500 mt-2">หรือลากไฟล์มาวางที่นี่</p>
              </div>
            </div>
            
            <!-- File Preview -->
            <div id="filePreview" class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3">
            <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-primary to-accent hover:from-blue-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center">
              <i class="fas fa-paper-plane mr-2"></i> ส่งแบบฟอร์ม
            </button>
            
            <button type="button" id="editBtn" class="flex-1 bg-gradient-to-r from-secondary to-green-500 hover:from-green-600 hover:to-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center hidden">
              <i class="fas fa-edit mr-2"></i> แก้ไขข้อมูล
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl p-8 flex flex-col items-center">
        <div class="w-16 h-16 border-t-4 border-primary border-solid rounded-full animate-spin mb-4"></div>
        <p class="text-gray-700 font-medium">กำลังประมวลผลข้อมูล...</p>
        <p class="text-gray-500 text-sm mt-2">กรุณารอสักครู่</p>
      </div>
    </div>
    
    <!-- Success Message -->
    <div id="successContainer" class="bg-white rounded-2xl shadow-xl overflow-hidden p-8 text-center hidden">
      <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 success-check">
        <i class="fas fa-check-circle text-green-600 text-4xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">ลงทะเบียนสำเร็จ!</h2>
      <p class="text-gray-600 mb-6">ข้อมูลของคุณถูกบันทึกเรียบร้อยแล้ว</p>
      
      <div class="mb-6 p-4 bg-blue-50 rounded-lg text-left">
        <h3 class="font-bold text-gray-700 mb-2">ข้อมูลที่ลงทะเบียน:</h3>
        <p id="successName" class="text-gray-600 mb-1"><i class="fas fa-user text-primary mr-2"></i> <span class="font-medium">-</span></p>
        <p id="successEmail" class="text-gray-600 mb-1"><i class="fas fa-envelope text-primary mr-2"></i> <span class="font-medium">-</span></p>
        <p id="successPhone" class="text-gray-600 mb-1"><i class="fas fa-phone text-primary mr-2"></i> <span class="font-medium">-</span></p>
      </div>
      
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <button id="closeBtn" class="bg-gradient-to-r from-primary to-accent hover:from-blue-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
          <i class="fas fa-times mr-2"></i> ปิดหน้าต่าง
        </button>
        <button id="editAfterBtn" class="bg-gradient-to-r from-secondary to-green-500 hover:from-green-600 hover:to-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
          <i class="fas fa-edit mr-2"></i> แก้ไขข้อมูล
        </button>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center text-gray-500 text-sm mt-12">
      <p>© 2023 ระบบลงทะเบียน LINE LIFF | สร้างด้วย Google Apps Script</p>
    </div>
  </div>
  
  <script>
    // ตัวแปรเก็บไฟล์ที่เลือก
    let selectedFiles = [];
    let isSubmitting = false; // ป้องกันการส่งซ้ำ
    
    // เริ่มต้น LIFF App
    async function initializeLiff() {
      try {
        // เปลี่ยนเป็น LIFF ID ของคุณ
        await liff.init({ 
          liffId: '1656079273-12vmyKy3', 
          withLoginOnExternalBrowser: true
        });
        
        console.log('LIFF initialized successfully');
        
        // แสดงสถานะการล็อกอิน
        await updateLoginStatus();
        
        // เริ่มต้นระบบไฟล์
        initFileUpload();
        
      } catch (error) {
        console.error('LIFF Initialization Error:', error);
        showError('ไม่สามารถเชื่อมต่อกับ LINE ได้', 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต', error.message);
      }
    }
    
    // เริ่มต้นระบบอัปโหลดไฟล์
    function initFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const dropZone = document.getElementById('dropZone');
      const filePreview = document.getElementById('filePreview');
      
      // จัดการการคลิก dropZone เพื่อเปิด file input
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });
      
      // จัดการการเปลี่ยนไฟล์ใน input
      fileInput.addEventListener('change', handleFileSelect);
      
      // จัดการ drag and drop
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropZone.classList.add('drag-over');
      }
      
      function unhighlight() {
        dropZone.classList.remove('drag-over');
      }
      
      // จัดการ drop
      dropZone.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }
      
      function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
      }
      
      function handleFiles(files) {
        // ตรวจสอบจำนวนไฟล์ (ลดเหลือ 3 ไฟล์)
        if (selectedFiles.length + files.length > 3) {
          showError('อัปโหลดได้สูงสุด 3 ไฟล์', 'กรุณาลดจำนวนไฟล์ลง');
          return;
        }
        
        // ตรวจสอบขนาดไฟล์ (ลดเหลือ 2MB ต่อไฟล์)
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > 2 * 1024 * 1024) {
            showError(`ไฟล์ ${file.name} มีขนาดใหญ่เกิน 2MB`, 'กรุณาเลือกไฟล์ที่มีขนาดเล็กกว่า');
            return;
          }
        }
        
        // เพิ่มไฟล์ที่เลือก
        for (let i = 0; i < files.length; i++) {
          selectedFiles.push(files[i]);
        }
        
        // แสดงตัวอย่างไฟล์
        previewFiles();
        
        // รีเซ็ต input เพื่อให้สามารถเลือกไฟล์เดิมซ้ำได้
        fileInput.value = '';
      }
    }
    
    // แสดงตัวอย่างไฟล์ที่เลือก
    function previewFiles() {
      const filePreview = document.getElementById('filePreview');
      filePreview.innerHTML = '';
      
      selectedFiles.forEach((file, index) => {
        const fileCard = document.createElement('div');
        fileCard.className = 'file-card bg-white rounded-lg shadow p-4 flex items-center';
        
        let previewContent = '';
        if (file.type.startsWith('image/')) {
          const url = URL.createObjectURL(file);
          previewContent = `
            <img src="${url}" alt="${file.name}" class="file-preview-img w-full h-20 object-cover rounded">
          `;
        } else {
          let fileIcon = '';
          let iconColor = 'text-blue-500';
          
          if (file.type === 'application/pdf') {
            fileIcon = 'file-pdf';
            iconColor = 'text-red-500';
          } else if (file.type.includes('word') || file.type.includes('document')) {
            fileIcon = 'file-word';
            iconColor = 'text-blue-600';
          } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) {
            fileIcon = 'file-excel';
            iconColor = 'text-green-600';
          } else {
            fileIcon = 'file';
            iconColor = 'text-gray-500';
          }
          
          previewContent = `
            <div class="text-center">
              <i class="fas fa-${fileIcon} ${iconColor} file-icon"></i>
              <p class="text-xs mt-1 text-gray-600 truncate">${file.name}</p>
            </div>
          `;
        }
        
        fileCard.innerHTML = `
          <div class="flex-shrink-0 w-20 h-20 flex items-center justify-center">
            ${previewContent}
          </div>
          <div class="ml-3 flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
          </div>
          <button class="ml-2 text-red-500 hover:text-red-700 remove-file" data-index="${index}">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        filePreview.appendChild(fileCard);
      });
      
      // เพิ่ม event listener สำหรับปุ่มลบ
      document.querySelectorAll('.remove-file').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.getAttribute('data-index'));
          selectedFiles.splice(index, 1);
          previewFiles();
        });
      });
    }
    
    // รูปแบบขนาดไฟล์
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // แปลงไฟล์เป็น base64 แบบ Chunked เพื่อประสิทธิภาพที่ดีขึ้น
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function() {
          try {
            const base64String = reader.result;
            if (!base64String) {
              reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
              return;
            }
            
            // แยกส่วนข้อมูล base64 ออกจากส่วน header
            const base64Data = base64String.split(',')[1];
            if (!base64Data) {
              reject(new Error('รูปแบบไฟล์ไม่ถูกต้อง'));
              return;
            }
            
            resolve({
              fileName: file.name,
              mimeType: file.type,
              size: file.size,
              data: base64Data
            });
          } catch (error) {
            console.error('Error processing file:', error);
            reject(new Error('เกิดข้อผิดพลาดในการประมวลผลไฟล์'));
          }
        };
        
        reader.onerror = function() {
          reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
        };
        
        reader.onabort = function() {
          reject(new Error('การอ่านไฟล์ถูกยกเลิก'));
        };
        
        // อ่านไฟล์เป็น data URL
        reader.readAsDataURL(file);
      });
    }
    
    // อัปเดตสถานะการล็อกอิน
    async function updateLoginStatus() {
      if (!liff.isLoggedIn()) {
        // แสดงปุ่มล็อกอิน
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('formContainer').classList.add('hidden');
        document.getElementById('successContainer').classList.add('hidden');
        return;
      }
      
      try {
        // ดึงโปรไฟล์ LINE
        const profile = await liff.getProfile();
        console.log('User profile:', profile);
        
        // แสดงข้อมูลโปรไฟล์ LINE
        document.getElementById('profilePicture').src = profile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        document.getElementById('lineName').textContent = profile.displayName;
        document.getElementById('userId').value = profile.userId;
        
        // ดึง email จาก ID Token (ถ้ามี)
        const idToken = liff.getIDToken();
        let userEmail = '';
        if (idToken) {
          try {
            const decodedToken = liff.getDecodedIDToken();
            userEmail = decodedToken?.email || '';
          } catch (e) {
            console.log('No email in ID token');
          }
        }
        
        // แสดง email ในส่วนโปรไฟล์
        if (userEmail) {
          document.getElementById('lineEmail').textContent = userEmail;
          document.getElementById('email').value = userEmail;
          document.getElementById('email').readOnly = true;
          document.getElementById('email').classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
          document.getElementById('lineEmail').textContent = 'ไม่พบอีเมลในโปรไฟล์ LINE';
        }
        
        // แสดงฟอร์มและซ่อนปุ่มล็อกอิน
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('formContainer').classList.remove('hidden');
        document.getElementById('successContainer').classList.add('hidden');
        
        // ตรวจสอบว่าผู้ใช้เคยลงทะเบียนแล้วหรือไม่
        await checkExistingRegistration(profile.userId);
        
      } catch (error) {
        console.error('Profile Error:', error);
        showError('ไม่สามารถดึงข้อมูลโปรไฟล์ได้', 'กรุณาลองใหม่อีกครั้ง', error.message);
      }
    }
    
    // ตรวจสอบการลงทะเบียนที่มีอยู่
    async function checkExistingRegistration(userId) {
      try {
        const response = await fetchWithTimeout('https://script.google.com/macros/s/AKfycbwpjzb0BRFJrSL0YZwcrIgse5uNbdDoJ5GaEWxbX8HhPTg1aHEeaJgBVURHbVrahUa3/exec', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'getUserData',
            userId: userId
          })
        }, 15000); // ลด timeout เหลือ 15 วินาที
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success' && data.userData) {
          // แสดงข้อมูลที่มีอยู่
          document.getElementById('name').value = data.userData.name || '';
          if (!document.getElementById('email').readOnly) {
            document.getElementById('email').value = data.userData.email || '';
          }
          document.getElementById('phone').value = data.userData.phone || '';
          
          // แสดงปุ่มแก้ไข
          document.getElementById('editBtn').classList.remove('hidden');
        }
      } catch (error) {
        console.log('ไม่พบข้อมูลการลงทะเบียน หรือ', error.message);
      }
    }
    
    // จัดการการล็อกอิน
    document.getElementById('loginButton').addEventListener('click', async () => {
      try {
        document.getElementById('loadingIndicator').classList.remove('hidden');
        
        if (!liff.isLoggedIn()) {
          await liff.login({ scope: 'profile email' });
        }
        
        await updateLoginStatus();
        document.getElementById('loadingIndicator').classList.add('hidden');
      } catch (error) {
        console.error('Login Error:', error);
        showError('ไม่สามารถล็อกอินได้', 'กรุณาลองใหม่อีกครั้ง', error.message);
        document.getElementById('loadingIndicator').classList.add('hidden');
      }
    });
    
    // จัดการการส่งฟอร์ม - แก้ไขหลายจุดสำคัญ
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ป้องกันการส่งซ้ำ
      if (isSubmitting) {
        console.log('Form is already being submitted');
        return;
      }
      
      // ตรวจสอบความถูกต้องของข้อมูล
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const userId = document.getElementById('userId').value;
      
      if (!name) {
        showError('กรุณากรอกชื่อ', 'ชื่อ-นามสกุลเป็นข้อมูลที่จำเป็น');
        document.getElementById('name').focus();
        return;
      }
      
      if (!email) {
        showError('กรุณากรอกอีเมล', 'อีเมลเป็นข้อมูลที่จำเป็น');
        document.getElementById('email').focus();
        return;
      }
      
      if (!isValidEmail(email)) {
        showError('รูปแบบอีเมลไม่ถูกต้อง', 'กรุณากรอกอีเมลให้ถูกต้อง');
        document.getElementById('email').focus();
        return;
      }
      
      if (!phone) {
        showError('กรุณากรอกเบอร์โทรศัพท์', 'เบอร์โทรศัพท์เป็นข้อมูลที่จำเป็น');
        document.getElementById('phone').focus();
        return;
      } else if (!/^\d{10}$/.test(phone)) {
        showError('รูปแบบเบอร์โทรศัพท์ไม่ถูกต้อง', 'กรุณากรอกเบอร์โทรศัพท์ 10 หลัก');
        document.getElementById('phone').focus();
        return;
      }
      
      // ตั้งค่า flag ป้องกันการส่งซ้ำ
      isSubmitting = true;
      
      // แสดงตัวโหลด
      document.getElementById('loadingIndicator').classList.remove('hidden');
      const submitBtn = document.getElementById('submitBtn');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังบันทึกข้อมูล...';
      submitBtn.disabled = true;
      
      try {
        // แปลงไฟล์เป็น base64 แบบทีละไฟล์เพื่อลด memory usage
        const base64Files = [];
        
        for (let i = 0; i < selectedFiles.length; i++) {
          try {
            console.log(`Converting file ${i + 1}/${selectedFiles.length}: ${selectedFiles[i].name}`);
            const base64File = await fileToBase64(selectedFiles[i]);
            base64Files.push(base64File);
          } catch (error) {
            console.error('Error converting file:', selectedFiles[i].name, error);
            throw new Error(`ไม่สามารถประมวลผลไฟล์ "${selectedFiles[i].name}" ได้: ${error.message}`);
          }
        }
        
        // สร้าง object ข้อมูล
        const formData = {
          action: 'register',
          userId: userId,
          name: name,
          email: email,
          phone: phone,
          files: base64Files,
          timestamp: new Date().toISOString()
        };
        
        console.log('Preparing to send form data:', {
          action: formData.action,
          userId: formData.userId,
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          filesCount: formData.files.length,
          totalSize: formData.files.reduce((sum, file) => sum + file.size, 0)
        });
        
        // URL ของ Google Apps Script
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwpjzb0BRFJrSL0YZwcrIgse5uNbdDoJ5GaEWxbX8HhPTg1aHEeaJgBVURHbVrahUa3/exec';
        
        // ส่งข้อมูลแบบ POST
        const response = await fetchWithTimeout(scriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        }, 60000); // เพิ่ม timeout เป็น 60 วินาที
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        // ตรวจสอบ HTTP status
        if (!response.ok) {
          const errorText = await response.text();
          console.error('HTTP error response:', errorText);
          throw new Error(`เซิร์ฟเวอร์ตอบกลับด้วยข้อผิดพลาด (${response.status}): ${response.statusText}`);
        }
        
        // แปลง response เป็น JSON
        let data;
        try {
          const responseText = await response.text();
          console.log('Raw response:', responseText);
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          throw new Error('ได้รับข้อมูลที่ไม่ถูกต้องจากเซิร์ฟเวอร์');
        }
        
        console.log('Parsed response data:', data);
        
        if (data.status === 'success') {
          // แสดงหน้าสำเร็จ
          showSuccessScreen({
            name: name,
            email: email,
            phone: phone,
            userId: userId
          });
          
          // รีเซ็ตไฟล์ที่เลือก
          selectedFiles = [];
          document.getElementById('filePreview').innerHTML = '';
          
          // รีเซ็ตฟอร์ม
          document.getElementById('registrationForm').reset();
          document.getElementById('userId').value = userId; // เก็บ userId ไว้
          
        } else {
          throw new Error(data.message || data.error || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ');
        }
      } catch (error) {
        console.error('Registration Error:', error);
        
        // แสดงข้อผิดพลาดที่เฉพาะเจาะจงมากขึ้น
        let errorTitle = 'บันทึกข้อมูลไม่สำเร็จ';
        let errorMessage = error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorTitle = 'ปัญหาการเชื่อมต่อ';
          errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
        } else if (error.message.includes('timeout') || error.message.includes('หมดเวลา')) {
          errorTitle = 'การเชื่อมต่อหมดเวลา';
          errorMessage = 'การส่งข้อมูลใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง';
        } else if (error.message.includes('ไฟล์')) {
          errorTitle = 'ปัญหาไฟล์';
          errorMessage = error.message;
        }
        
        showError(errorTitle, errorMessage, `รายละเอียด: ${error.message}`);
      } finally {
        // รีเซ็ตสถานะ
        isSubmitting = false;
        document.getElementById('loadingIndicator').classList.add('hidden');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });
    
    // แสดงหน้าสำเร็จ
    function showSuccessScreen(userData) {
      // อัปเดตข้อมูลในหน้าสำเร็จ
      document.getElementById('successName').innerHTML = `<i class="fas fa-user text-primary mr-2"></i> <span class="font-medium">${userData.name}</span>`;
      document.getElementById('successEmail').innerHTML = `<i class="fas fa-envelope text-primary mr-2"></i> <span class="font-medium">${userData.email}</span>`;
      document.getElementById('successPhone').innerHTML = `<i class="fas fa-phone text-primary mr-2"></i> <span class="font-medium">${userData.phone}</span>`;
      
      // แสดงหน้าสำเร็จและซ่อนฟอร์ม
      document.getElementById('formContainer').classList.add('hidden');
      document.getElementById('successContainer').classList.remove('hidden');
      document.getElementById('errorContainer').classList.add('hidden');
      
      // เลื่อนขึ้นด้านบน
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // แสดงข้อผิดพลาด - ปรับปรุงให้แสดงรายละเอียดมากขึ้น
    function showError(title, message, details = '') {
      document.getElementById('errorTitle').textContent = title;
      document.getElementById('errorMessage').textContent = message;
      
      const errorDetails = document.getElementById('errorDetails');
      if (details) {
        errorDetails.textContent = details;
        errorDetails.classList.remove('hidden');
      } else {
        errorDetails.classList.add('hidden');
      }
      
      document.getElementById('errorContainer').classList.remove('hidden');
      
      // เลื่อนไปที่ error message
      document.getElementById('errorContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // ซ่อนข้อผิดพลาดหลังจาก 10 วินาที
      setTimeout(() => {
        document.getElementById('errorContainer').classList.add('hidden');
      }, 10000);
    }
    
    // ปุ่มลองอีกครั้ง
    document.getElementById('retryButton').addEventListener('click', () => {
      document.getElementById('errorContainer').classList.add('hidden');
      // รีเซ็ต isSubmitting flag
      isSubmitting = false;
    });
    
    // ปุ่มแก้ไขข้อมูล
    document.getElementById('editBtn').addEventListener('click', () => {
      // เปิดใช้งานฟิลด์ที่ไม่ใช่ readonly
      const fields = ['name', 'phone'];
      if (!document.getElementById('email').readOnly) {
        fields.push('email');
      }
      
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.disabled = false;
        field.classList.remove('bg-gray-100', 'cursor-not-allowed');
      });
      
      // ซ่อนปุ่มแก้ไข
      document.getElementById('editBtn').classList.add('hidden');
      
      // โฟกัสที่ช่องแรก
      document.getElementById('name').focus();
    });
    
    // ปุ่มแก้ไขข้อมูลจากหน้าสำเร็จ
    document.getElementById('editAfterBtn').addEventListener('click', () => {
      // แสดงฟอร์มและซ่อนหน้าสำเร็จ
      document.getElementById('successContainer').classList.add('hidden');
      document.getElementById('formContainer').classList.remove('hidden');
      
      // เลื่อนไปที่ฟอร์ม
      document.getElementById('formContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    });
    
    // ปุ่มปิดหน้าต่าง
    document.getElementById('closeBtn').addEventListener('click', () => {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        // ถ้าเปิดในเบราว์เซอร์ธรรมดา
        if (confirm('คุณต้องการปิดหน้าต่างนี้หรือไม่?')) {
          window.close();
        }
      }
    });
    
    // ฟังก์ชันตรวจสอบอีเมล
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // ฟังก์ชัน fetch with timeout - ปรับปรุงให้ทำงานได้ดีขึ้น
    function fetchWithTimeout(url, options, timeout = 30000) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      return fetch(url, {
        ...options,
        signal: controller.signal
      }).then(response => {
        clearTimeout(timeoutId);
        return response;
      }).catch(error => {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง');
        }
        throw error;
      });
    }
    
    // เริ่มต้นแอปพลิเคชัน
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing...');
      initializeLiff();
    });
    
    // จัดการ error ที่ไม่คาดคิด
    window.addEventListener('error', (event) => {
      console.error('Unhandled error:', event.error);
      showError('เกิดข้อผิดพลาดระบบ', 'กรุณารีเฟรชหน้าเว็บและลองใหม่อีกครั้ง', event.error?.message || '');
    });
    
    // จัดการ unhandled promise rejection
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showError('เกิดข้อผิดพลาดระบบ', 'กรุณารีเฟรชหน้าเว็บและลองใหม่อีกครั้ง', event.reason?.message || '');
    });
  </script>
</body>
</html>
